---
title: "Familiarity-Uncertainty biased Global model (Kachergis et al, 2012)"
author: "Christine Soh Yue"
date: "2025-09-18"
output: html_document:
  toc: true
  theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r requirements}
library(pso)
library(tidyverse)
```

# Model
copied from Associative Uncertainty- (Entropy) & Familiarity-Biased Model

George Kachergis  george.kachergis@gmail.com

(https://github.com/kachergis/word_learning_models)

These models are copied from Kachergis' word github. There is one modification
that we make -- to remove the cross-initialization that results in a 
target-referent bias in the first exposure.
```{r model}
shannon.entropy <- function(p) {
	if (min(p) < 0 || sum(p) <= 0)
		return(NA)
	p.norm <- p[p>0]/sum(p)
	-sum(log2(p.norm)*p.norm)
}

update_known <- function(m, tr_w, tr_o) {
  startval = .01
  
  for(i in tr_w) { # for each word in the input
    for(c in 1:dim(m)[2]) { # for each column
      if(sum(m[,c]>0) & m[i,c]==0) { 
        # if the sum of the column is greater than 0 (i.e. the object has previously
        # been seen) and the word-object pair is 0, set it to the startval
        m[i,c] = startval
        # cross-initialization
        # if(c<nrow(m)) m[c,i] = startval # Something weird is going on here
      }
    }
    for(j in tr_o) { # for each object
      if(m[i,j]==0) m[i,j] = startval # set the word, object to startval if 0
      # cross-initialization
      # if(j<nrow(m) && m[j,i]==0) m[j,i] = startval # Something weird is going on here
    }
  }
  return(m)
}

get_perf <- function(m) {
  perf <- rep(0, nrow(m))
  names(perf) <- rownames(m)
  for (ref in colnames(m)) {
    if (!(ref %in% rownames(m))) {
      next
    }
    correct <- m[ref, ref]
    total <- sum(m[ref,])
    if (total == 0) {
      next
    }
    perf[ref] <- correct / total
  }
  return(perf)
}

model <- function(params, ord, reps=1, test_noise=0) {
	X <- params[1] # associative weight to distribute
	B <- params[2] # weighting of uncertainty vs. familiarity
	C <- params[3] # decay
	
	voc_sz = max(unlist(ord$words), na.rm=TRUE) # vocabulary size
	ref_sz = max(unlist(ord$objs), na.rm=TRUE) # number of objects

	traj = list()
	m <- matrix(0, voc_sz, ref_sz) # association matrix
	perf = matrix(0, reps, voc_sz) # a row for each block
	# training
	for(rep in 1:reps) { # for trajectory experiments, train multiple times
	  for(t in 1:nrow(ord$words)) {

  		tr_w = as.integer(ord$words[t,])
  		tr_w = tr_w[!is.na(tr_w)]
  		tr_o = as.integer(ord$objs[t,])
  		tr_o = tr_o[!is.na(tr_o)]
  		m = update_known(m, tr_w, tr_o) # what's been seen so far?
  		ent_w = c() # more entropy = more dispersive
  		for(w in tr_w) { ent_w = c(ent_w, shannon.entropy(m[w,])) }
  		ent_w = exp(B*ent_w)

  		ent_o = c() # more entropy = more dispersive
  		for(o in tr_o) { ent_o = c(ent_o, shannon.entropy(m[,o])) }
  		ent_o = exp(B*ent_o)

  		nent = (ent_w %*% t(ent_o))
  		assocs = m[tr_w,tr_o]
  		denom = sum(assocs * nent)
  		m = m*C # decay everything
  		# update associations on this trial
  		m[tr_w,tr_o] = m[tr_w,tr_o] + (X * assocs * (ent_w %*% t(ent_o))) / denom

  		index = (rep-1)*length(ord$trials) + t # index for learning trajectory
  		traj[[index]] = m
	  }
	  m_test = m+test_noise # test noise constant k
	  perf[rep,] = diag(m_test) / rowSums(m_test)
	}
	want = list(perf=perf, matrix=m, traj=traj)
	return(want)
}

run_model <- function(cond, parameters, print_perf=F) {
  require(pso) # or require(DEoptim)
  mod = model(parameters, ord=cond$train)
  if(print_perf) print(mod$perf)
  return(mod)
}

```

```{r fit_model}
meanSSE <- function(par, order, human_perf) {
  mod = model(par, order$train)
  return(sum((mod$perf-human_perf)^2))
}

fit_model <- function(model_name, order, par_lower, par_upper, se_fn) {
  lowest_SSE = 100
  best_par = NA
  par_init = (par_lower + par_upper) / 2
  startt = Sys.time()
  cat("Model\tOrder\tSSE\tParameters\n")
  for(test_row in 1:10) { 
    best <- psoptim(par_init, se_fn, ord=order, human_perf=unlist(order$HumanItemAcc), lower=par_lower, upper=par_upper)
    if(best$value < lowest_SSE){
      best_par = best$par
      lowest_SSE = best$value
    }
    cat(model_name,'\t',order$Condition,'\t',best$value,'\t',best$par,'\n')
  }
  stopt = Sys.time()
  print(stopt-startt)
  print(paste0(best_par, collapse=", "))
  return(best_par)
}
```

I defined this function: Kachergis approximates test over the entire association
matrix, but in CSWL studies, there are typically fewer foils than the entire set.
In the case where we know the test, we define the test function. Otherwise, we
use the approximation of perf.
```{r test_fn}
test_model <- function(expt, params, test_words, test_objects, exposure_length) {
  mod = run_model(expt, params, print_perf=F)
  final_trajectory = mod$traj[exposure_length][[1]]

  test_performance = matrix(0, 1, nrow(test_words))
  for(test_row in 1:nrow(test_words)) {
    test_options = as.integer(test_objects[test_row,])
    # The first item in the option list must be the target referent
    numerator = final_trajectory[test_words[test_row,], test_options[1]]
    denominator = 0
    for(option in test_options) {
      denominator = denominator + final_trajectory[test_words[test_row,], option]
    }
    test_performance[1,test_row] = numerator / denominator
  }
                      
  return(test_performance)
}

```

# Simulations

Here, we run simulations on 4 different studies.

## Trueswell, Medina, Hafri, & Gleitman, 2013

### Input
Trueswell input: 12 words, 5 exposures interleaved

Human performance is approximated using the published values
```{r trueswell_words_objs}
trueswell_words <- matrix(c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12,
                            1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12,
                            1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12,
                            1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12,
                            1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12
                       ),
                     nrow = 60,
                     ncol = 1, byrow=T
                     )


trueswell_obj <- matrix(c(1, 5, 2, 7, 3,      2, 3, 12, 9, 6,    3, 4, 2, 8, 10,   
                          4, 7, 11, 9, 1,     5, 8, 10, 12, 6,   6, 5, 4, 11, 10, 
                          7, 11, 6, 10, 4,    8, 1, 4, 2, 3,     9, 11, 7, 2, 10, 
                          10, 8, 2, 3, 11,   11, 2, 5, 8, 7,    12, 1, 5, 10, 8, 
                          1, 6, 2, 12, 8,     2, 4, 3, 10, 11,   3, 12, 11, 9, 1, 
                          4, 12, 6, 2, 8,     5, 4, 7, 3, 2,     6, 7, 4, 3, 1, 
                          7, 3, 2, 12, 5,     8, 9, 11, 4, 6,    9, 11, 10, 5, 6, 
                          10, 1, 12, 11, 8,  11, 5, 3, 10, 9,   12, 9, 3, 2, 11,
                          1, 12, 7, 10, 9,    2, 7, 1, 10, 4,    3, 6, 9, 7, 4, 
                          4, 7, 3, 12, 1,     5, 6, 3, 7, 4,     6, 8, 7, 5, 9, 
                          7, 11, 1, 5, 9,     8, 12, 6, 10, 5,   9, 8, 2, 3, 4, 
                          10, 6, 12, 9, 1,    11, 12, 10, 6, 9,  12, 7, 8, 2, 11, 
                          1, 4, 8, 5, 3,    2, 1, 6, 8, 7,    3, 5, 12, 7, 2, 
                          4, 10, 9, 2, 5,     5, 2, 1, 8, 9,     6, 3, 12, 10, 1, 
                          7, 2, 12, 6, 9,     8, 11, 7, 5, 1,    9, 8, 12, 6, 3, 
                          10, 5, 3, 7, 4,     11, 1, 3, 6, 4,    12, 1, 6, 10, 7, 
                          1, 11, 10, 9, 6,     2, 8, 9, 11, 5,    3, 5, 11, 1, 8, 
                          4, 6, 10, 3, 11,    5, 12, 1, 11, 10,    6, 12, 8, 11, 9, 
                          7, 1, 10, 4, 8,      8, 12, 7, 2, 3,     9, 5, 4, 12, 7, 
                          10, 9, 2, 5, 4,      11, 4, 1, 2, 8,     12, 9, 6, 5, 4
                       ),
                     nrow = 60,
                     ncol = 5, byrow=T
                     )
```

```{r trueswell_input}
trueswell <- list("train" = list("words" = trueswell_words, 
                                 "objs" = trueswell_obj), 
                  "Nsubj" = 40, 
                   "Condition" = "Trueswell", 
                   "HumanItemAcc" = c(0.333, 0.333, 0.333, 0.333, 0.333, 0.333,
                                      0.333, 0.333, 0.333, 0.333, 0.333, 0.333)
                  )
```

### Test and fit functions

The test function is defined separately: in the Trueswell et. al. work, there
isn't a final test.
```{r trueswell_test}
test_model_trueswell <- function(expt, params) {
  mod = run_model(expt, params, print_perf=F)
  
  words = expt$train$words
  objs = expt$train$objs
  test_performance = matrix(0, 1, nrow(words))
  for(test_row in 1:nrow(words)) {
    test_options = as.integer(objs[test_row,])
    trajectory = mod$traj[test_row][[1]]
    numerator = trajectory[test_options[1], test_options[1]]
    denominator = 0
    for(option in test_options) {
      denominator = denominator + trajectory[test_options[1], option]
    }
    test_performance[1,test_row] = numerator / denominator
  }
                      
  return(test_performance)
}
```

We define the Mean SSE function to compare the final exposure

```{r trueswell_fit}
meanSSE_trueswell <- function(par, order, human_perf) {
  mod = test_model_trueswell(order, par)
  return(sum((mod[1, 49:60]-human_perf)^2))
}

trueswell_mod_fit <- fit_model("kachergis", trueswell, c(.001,.1,.5), c(5,15,1), meanSSE_trueswell)
```


### Fit to entire trajectory
```{r trueswell_fit_entire}
meanSSE_trueswell_full <- function(par, order, human_perf) {
  mod = test_model_trueswell(order, par)
  return(sum((mod-human_perf)^2))
}

trueswell_full <- list("train" = list("words" = trueswell_words, 
                                 "objs" = trueswell_obj), 
                  "Nsubj" = 40, 
                   "Condition" = "Trueswell", 
                   "HumanItemAcc" = c(0.178, 0.178, 0.178, 0.178, 0.178, 0.178, 
                                      0.178, 0.178, 0.178, 0.178, 0.178, 0.178, 
                                      
                                      0.222, 0.222, 0.222, 0.222, 0.222, 0.222, 
                                      0.222, 0.222, 0.222, 0.222, 0.222, 0.222, 
                                      
                                      0.272, 0.272, 0.272, 0.272, 0.272, 0.272, 
                                      0.272, 0.272, 0.272, 0.272, 0.272, 0.272, 
                                      
                                      0.311, 0.311, 0.311, 0.311, 0.311, 0.311,
                                      0.311, 0.311, 0.311, 0.311, 0.311, 0.311,
                                      
                                      0.333, 0.333, 0.333, 0.333, 0.333, 0.333,
                                      0.333, 0.333, 0.333, 0.333, 0.333, 0.333)
                  )

trueswell_mod_full_fit <- fit_model("kachergis", trueswell_full, c(.001,.1,.5), c(5,15,1), meanSSE_trueswell_full)
```

### Results
```{r trueswell_results}
trueswell_results <- test_model_trueswell(trueswell, trueswell_mod_fit)
print("fubg")
mean(trueswell_results[1,13:60])
print("trajectory")
paste0(round(c(mean(trueswell_results[1, 1:12]), mean(trueswell_results[1, 13:24]),
  mean(trueswell_results[1, 25:36]), mean(trueswell_results[1, 37:48]),
  mean(trueswell_results[1, 49:60])), 3), collapse=", ")
```

```{r trueswell_full_trajectory_results}
trueswell_full_fit_results <- test_model_trueswell(trueswell, trueswell_mod_full_fit)
print("fubg trained on trajectory")
mean(trueswell_full_fit_results[1,13:60])
print("trajectory")
paste0(round(c(mean(trueswell_full_fit_results[1, 1:12]), 
               mean(trueswell_full_fit_results[1, 13:24]),
               mean(trueswell_full_fit_results[1, 25:36]), 
               mean(trueswell_full_fit_results[1, 37:48]),
               mean(trueswell_full_fit_results[1, 49:60])), 3), 
       collapse=", ")
```

## Yurovsky & Yu, 2008
### Input
We generate this from the published work -- the actual input may be slightly 
different.

There are two different object inputs: massed (obj1) and interleaved (obj2)
```{r yy_words_objs}
yy_words <- matrix(c(1, 3, 2, 11,   2, 9, 4, 5,   4, 7, 6, 1, 
                     6, 2, 12, 3,   3, 1, 4, 12,  1, 5, 6, 8, 
                     6, 4, 11, 2,   10, 1, 5, 3,  2, 5, 8, 4, 
                    10, 9, 6, 2,   1, 5, 7, 11,  3, 5, 10, 6, 
                     4, 10, 3, 5,   4, 3, 8, 1,   12, 2, 5, 8, 
                     1, 3, 6, 12,   2, 7, 3, 4,   3, 2, 11, 8, 
                    11, 5, 6, 4,   2, 10, 1, 4,  4, 9, 1, 12, 
                     8, 3, 9, 6,    4, 6, 10, 7,  1, 9, 2, 6, 
                     3, 5, 9, 7,    2, 5, 1, 7,   6, 5, 11, 12 
                    ),
                    nrow = 27,
                    ncol = 4, byrow=T
                    )

yy_obj1 <- matrix(c( 1, 11, 3, 2,    9, 5, 4, 2,      16, 6, 7, 1,
                     3, 2, 6, 12,    3, 4, 12, 1,     8, 6, 5, 1,
                     6, 4, 11, 2,    1, 3, 10, 5,     4, 8, 5, 2,
                     6, 9, 2, 10,     11, 5, 7, 1,     6, 5, 3, 10,
                    17, 10, 4, 3,    15, 8, 13, 16,   12, 14, 17, 8,
                    12, 18, 15, 13,  7, 16, 14, 15,   8, 11, 14, 15,
                    11, 17, 16, 18,  10, 14, 16, 13,  9, 12, 13, 16,
                    18, 8, 15, 9,    16, 10, 7, 18,   13, 9, 18, 14,
                    15, 7, 9, 17,    14, 17, 13, 7,    18, 11, 12, 17
                    ), 
                    nrow = 27,
                    ncol = 4, byrow=T
                    )

yy_obj2 <- matrix(c( 1, 11, 3, 2,    9, 5, 4, 14,     16, 6, 7, 13,
                    15, 2, 18, 12,   3, 4, 12, 1,     8, 6, 17, 13,
                    18, 16, 11, 14,  1, 15, 10, 5,    4, 8, 17, 2,
                     6, 9, 14, 10,    11, 5, 7, 13,    18, 17, 3, 10,
                     5, 10, 16, 15,   3, 8, 1, 4,      12, 2, 17, 8,
                    12, 6, 15, 13,   7, 16, 14, 3,    8, 11, 2, 15,
                    11, 5, 4, 18,    10, 14, 16, 1,   9, 12, 13, 4,
                     6, 8, 3, 9,      16, 10, 7, 18,   1, 9, 6, 2,
                    15, 7, 9, 17,    14, 5, 13, 7,    18, 11, 12, 17
                    ), 
                    nrow = 27,
                    ncol = 4, byrow=T
                    )
```

There are three different tests: primacy, recency, and both. To output the 
"both" test results, we run the double meaning items twice -- once with the 
first meaning and once with the second meaning. The FUbG model at test
just draws from the final trajectory, so separating it like this doesn't
make a difference.
```{r yy_test_input}
yy_test_words <- matrix(c(
  1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6
),
nrow = 18,
ncol = 1, byrow = T)

yy_test_primacy <- matrix(c(
  1, 7, 9, 18,     2, 12, 17, 1,    3, 17, 16, 13,
  4, 10, 9, 7,     5, 4, 11, 14,    6, 10, 1, 15,
  7, 18, 8, 4,     8, 14, 11, 15,   9, 2, 17, 5,
  10, 13, 3, 2,    11, 16, 6, 12,   12, 8, 6, 15,
  # DUMMY
  1, 7, 9, 18,     2, 12, 17, 1,    3, 17, 16, 13,
  4, 10, 9, 7,     5, 4, 11, 14,    6, 10, 1, 15
),
nrow = 18,
ncol = 4, byrow = T)


yy_test_recency <- matrix(c(
  13, 7, 9, 6,    14, 12, 5, 1,     15, 17, 4, 1,
  16, 10, 9, 7,   17, 4, 11, 2,     18, 10, 1, 15,
  7, 18, 8, 4,    8, 14, 11, 3,     9, 2, 17, 5,
  10, 13, 3, 2,   11, 16, 6, 12,    12, 8, 6, 15,
  # DUMMY
  13, 7, 9, 6,    14, 12, 5, 1,     15, 17, 4, 1,
  16, 10, 9, 7,   17, 4, 11, 2,     18, 10, 1, 15
),
nrow = 18,
ncol = 4, byrow = T)

yy_test_both <- matrix(c(
  1, 13, 7, 9,     2, 14, 12, 1,     3, 15, 17, 1,
  4, 16, 10, 9,    5, 17, 4, 11,     6, 18, 10, 15,
  
  7, 18, 8, 4,     8, 14, 11, 3,     9, 2, 17, 5,
  10, 13, 3, 2,    11, 16, 6, 12,    12, 8, 6, 15,
  
  13, 1, 7, 9,     14, 2, 12, 1,     15, 3, 17, 1,
  16, 4, 10, 9,    17, 5, 4, 11,     18, 6, 10, 15
),
nrow = 18,
ncol = 4, byrow = T)
```

```{r yu_yurovsky_input}
yy_1_primacy <- list("train" = list("words" = yy_words, "objs" = yy_obj1), 
                             "Nsubj" = 40, 
                             "Condition" = "Yurovsky_expt1_primacy", 
                             "HumanItemAcc" = c(0.580, 0.580, 0.580, 0.580, 0.580, 0.580,
                                                0.642, 0.642, 0.642, 0.642, 0.642, 0.642))

yy_1_recency <- list("train" = list("words" = yy_words, "objs" = yy_obj1), 
                             "Nsubj" = 40, 
                             "Condition" = "Yurovsky_epxt1_recency", 
                             "HumanItemAcc" = c(0.510, 0.510, 0.510, 0.510, 0.510, 0.510,
                                                0.642, 0.642, 0.642, 0.642, 0.642, 0.642))

yy_1_both <- list("train" = list("words" = yy_words, "objs" = yy_obj1), 
                             "Nsubj" = 40, 
                             "Condition" = "Yurovsky_expt1_both", 
                             "HumanItemAcc" = c(0.524, 0.524, 0.524, 0.524, 0.524, 0.524,
                                                0.642, 0.642, 0.642, 0.642, 0.642, 0.642,
                                                0.292, 0.292, 0.292, 0.292, 0.292, 0.292))

yy_1_expt <- list("primacy" = yy_1_primacy,
                 "recency" = yy_1_recency,
                 "both" = yy_1_both,
                 "Condition" = "Yurovsky_expt1")

yy_2_primacy <- list("train" = list("words" = yy_words, "objs" = yy_obj2), 
                             "Nsubj" = 40, 
                             "Condition" = "Yurovsky_expt2_primacy", 
                             "HumanItemAcc" = c(0.524, 0.524, 0.524, 0.524, 0.524, 0.524,
                                                0.521, 0.521, 0.521, 0.521, 0.521, 0.521))

yy_2_recency <- list("train" = list("words" = yy_words, "objs" = yy_obj2), 
                             "Nsubj" = 40, 
                             "Condition" = "Yurovsky_expt2_recency", 
                             "HumanItemAcc" = c(0.517, 0.517, 0.517, 0.517, 0.517, 0.517,
                                                0.582, 0.582, 0.582, 0.582, 0.582, 0.582))

yy_2_both <- list("train" = list("words" = yy_words, "objs" = yy_obj2), 
                             "Nsubj" = 40, 
                             "Condition" = "Yurovsky_expt2_both", 
                             "HumanItemAcc" = c(0.350, 0.350, 0.350, 0.350, 0.350, 0.350,
                                                0.575, 0.575, 0.575, 0.575, 0.575, 0.575,
                                                0.377, 0.377, 0.377, 0.377, 0.377, 0.377))

yy_2_expt <- list("primacy" = yy_2_primacy, 
                 "recency" = yy_2_recency, 
                 "both" = yy_2_both,
                 "Condition" = "Yurovsky_expt2")

yy_expt <- list("one" = yy_1_expt,
              "two" = yy_2_expt,
              "Condition" = "Yurovsky")
```

### Fit functions
```{r yu_yurovsky_sse_fn}
yy_meanSSE_primacy <- function(par, order, human_perf) {
  mod = test_model(order, par, yy_test_words, yy_test_primacy, 27)[1:12]
  return(sum((mod-human_perf)^2))
}

yy_meanSSE_recency <- function(par, order, human_perf) {
  mod = test_model(order, par, yy_test_words, yy_test_recency, 27)[1:12]
  return(sum((mod-human_perf)^2))
}

yy_meanSSE_both <- function(par, order, human_perf) {
  mod = test_model(order, par, yy_test_words, yy_test_both, 27)
  return(sum((mod-human_perf)^2))
}

yy_meanSSE_expt <- function(par, order, human_perf) {
  return(sum(yy_meanSSE_primacy(par, order$primacy, unlist(order$primacy$HumanItemAcc)),
             yy_meanSSE_recency(par, order$recency, unlist(order$recency$HumanItemAcc)),
             yy_meanSSE_both(par, order$both, unlist(order$both$HumanItemAcc))
             ))
}

yy_meanSSE <- function(par, order, human_perf) {
  return(sum(yy_meanSSE_expt(par, order$one, NA), yy_meanSSE_expt(par, order$two, NA)))
}
```

```{r yu_yurovsky_fit_expt1}

yy_1_p_mod_fit <- fit_model("kachergis", yy_1_primacy, c(.001,.1,.5), c(5,15,1), 
                            yy_meanSSE_primacy) 

yy_1_r_mod_fit <- fit_model("kachergis", yy_1_recency, c(.001,.1,.5), c(5,15,1), 
                            yy_meanSSE_recency)

yy_1_b_mod_fit <- fit_model("kachergis", yy_1_both, c(.001,.1,.5), c(5,15,1), 
                            yy_meanSSE_both) 

yy_1_mod_fit <- fit_model("kachergis", yy_1_expt, c(.001,.1,.5), c(5,15,1),
                          yy_meanSSE_expt)
```

```{r yu_yurovsky_fit_expt2}

yy_2_p_mod_fit <- fit_model("kachergis", yy_2_primacy, c(.001,.1,.5), c(5,15,1), 
                            yy_meanSSE_primacy) 

yy_2_r_mod_fit <- fit_model("kachergis", yy_2_recency, c(.001,.1,.5), c(5,15,1), 
                            yy_meanSSE_recency)

yy_2_b_mod_fit <- fit_model("kachergis", yy_2_both, c(.001,.1,.5), c(5,15,1), 
                            yy_meanSSE_both) 

yy_2_mod_fit <- fit_model("kachergis", yy_2_expt, c(.001,.1,.5), c(5,15,1),
                          yy_meanSSE_expt)
```

```{r yu_yurovsky_fit_expt_all}
yy_mod_fit <- fit_model("kachergis", yy_expt, c(.001,.1,.5), c(5,15,1),
                          yy_meanSSE)
```

```{r yu_yurovsky_params}
print("the best parameters tuned by condition are:")

print(paste0("expt 1 primacy: ", paste0(unlist(yy_1_p_mod_fit), collapse=", ")))
print(paste0("expt 1 recency: ", paste0(unlist(yy_1_r_mod_fit), collapse=", ")))
print(paste0("expt 1 both: ", paste0(unlist(yy_1_b_mod_fit), collapse=", ")))

print(paste0("expt 2 primacy: ", paste0(unlist(yy_2_p_mod_fit), collapse=", ")))
print(paste0("expt 2 recency: ", paste0(unlist(yy_2_r_mod_fit), collapse=", ")))
print(paste0("expt 2 both: ", paste0(unlist(yy_2_b_mod_fit), collapse=", ")))

print("the best parameters tuned by expt are:")

print(paste0("expt 1: ", paste0(unlist(yy_1_mod_fit), collapse=", ")))
print(paste0("expt 2: ", paste0(unlist(yy_2_mod_fit), collapse=", ")))

print("the best parameters tuned overall are:")

print(paste0(unlist(yy_1_mod_fit), collapse=", "))
```

### Results

```{r yu_yurovsky_result_fn}
yy_run_expt <- function(expt, prim_par, rec_par, both_par) {
  results = matrix(0, 1, 7)
  if(expt == 1) {
    yy_p <- test_model(yy_1_primacy, prim_par, yy_test_words, yy_test_primacy, 27)[1:12]
    yy_r <- test_model(yy_1_recency, rec_par, yy_test_words, yy_test_recency, 27)[1:12]
    yy_b <- test_model(yy_1_both, both_par, yy_test_words, yy_test_both, 27)
  } else {
    yy_p <- test_model(yy_2_primacy, prim_par, yy_test_words, yy_test_primacy, 27)[1:12]
    yy_r <- test_model(yy_2_recency, rec_par, yy_test_words, yy_test_recency, 27)[1:12]
    yy_b <- test_model(yy_2_both, both_par, yy_test_words, yy_test_both, 27)
  }
  results[1, 1] = mean(yy_p[7:12])
  results[1, 2] = mean(yy_r[7:12])
  results[1, 3] = mean(yy_b[7:12])
  
  results[1, 4] = mean(yy_p[1:6])
  results[1, 5] = mean(yy_r[1:6])
  results[1, 6] = mean(yy_b[1:6])
  results[1, 7] = mean(yy_b[13:18])

  return(round(results, 3))
}
```

```{r yu_yurovsky_results}
print("Experiment 1 tuned to each condtiion")
paste0(yy_run_expt(1, yy_1_p_mod_fit, yy_1_r_mod_fit, yy_1_b_mod_fit), collapse=", ")

print("Experiment 2 tuned to each condtiion")
paste0(yy_run_expt(2, yy_2_p_mod_fit, yy_2_r_mod_fit, yy_2_b_mod_fit), collapse=", ")

print("Experiment 1 tuned to massed")
paste0(yy_run_expt(1, yy_1_mod_fit, yy_1_mod_fit, yy_1_mod_fit), collapse=", ")

print("Experiment 2 tuned to interleaved")
paste0(yy_run_expt(2, yy_2_mod_fit, yy_2_mod_fit, yy_2_mod_fit), collapse=", ")

print("Experiment 1 & 2 tuned to total expt")
paste0(yy_run_expt(1, yy_mod_fit, yy_mod_fit, yy_mod_fit), collapse=", ")
paste0(yy_run_expt(2, yy_mod_fit, yy_mod_fit, yy_mod_fit), collapse=", ")

```

## Yu & Smith
### Input
```{r yu_smith_words_objects}
yu_smith_4_wo <- matrix(c( 1,  4,  7, 16,   2,  9, 10, 13,   5, 15, 17, 18,
                        4,  7,  9, 17,   3,  6, 12, 14,  10, 14, 16, 18,
                        6,  8, 11, 12,   1,  3, 11, 13,   9, 10, 13, 18,
                        4, 15, 16, 17,   2,  5,  8, 15,   3,  5,  7, 11,
                        7, 11, 13, 15,   3,  5,  6, 12,   9, 10, 12, 17,
                        1,  2,  8, 18,   1,  6,  8, 16,   3,  5, 10, 17,
                        1,  5, 11, 15,   1,  7, 16, 17,  13, 14, 15, 18,
                        2,  8,  9, 12,   9, 10, 13, 14,   4,  6,  7, 16, 
                        2,  8, 11, 14,   3,  4,  6, 12,   2,  4,  8, 14
                       ),
                     nrow = 27,
                     ncol = 4, byrow=T
                     )

yu_smith_3_wo <- matrix(c( 1,  6, 17,   8,  7, 15,   4, 13, 17,   3,  2, 16,
                        8,  9, 16,   1,  5, 14,   2,  9, 11,   8, 12, 13,
                        4,  7, 11,   1,  8, 10,   7,  5, 17,   3,  6, 15,
                        4,  2, 10,   3, 11, 17,   2,  5,  6,   1, 13, 15,
                        8, 14, 18,   4,  9, 15,   3, 13, 18,   5, 11, 15,
                       15, 18, 16,   5, 10, 18,   9, 12, 18,  10, 12, 17,
                        4,  5, 16,   6, 10, 13,   8, 11,  6,   2, 12, 14,
                        7,  9, 10,   1, 3,  9,    6, 14, 16,   2, 17, 18,
                        4,  3, 14,   7, 13, 14,   1, 11, 12,   7, 16, 12
                       ),
                     nrow = 36,
                     ncol = 3, byrow=T
                     )

yu_smith_2_wo <- matrix(c( 5, 10,   4,  5,   6, 15,   1,  6,  12, 15,  15, 10, 
                        7,  8,  14, 12,   7, 18,  14, 15,   1,  4,   7, 17, 
                        3, 13,  10, 17,   5,  9,  11, 18,   2,  9,  17,  2, 
                        9, 13,   7,  1,  17, 10,  13,  6,   1,  2,   3, 15, 
                        8, 11,  12,  3,  11, 12,  16,  3,   3, 14,   4, 17, 
                        2, 18,   8,  9,  11, 13,   3,  1,  13, 17,   2,  8, 
                        4,  6,   4,  7,  16, 18,   5,  1,   6, 14,  16, 10, 
                        5, 11,   7, 16,   8, 10,   2, 11,  14, 18,  12,  9, 
                       13, 16,   5,  8,   9, 14,  16, 15,   6, 12,   4, 18 
                       ),
                     nrow = 54,
                     ncol = 2, byrow=T
                     )
```

```{r yu_smith_input}

yu_smith_4 <- list("train" = list("words" = yu_smith_4_wo, 
                                  "objs" = yu_smith_4_wo), 
                   "Nsubj" = 40, 
                   "Condition" = "Yu_smith_4x4", 
                   "HumanItemAcc" = c(0.53, 0.53, 0.53, 0.53, 0.53, 0.53,
                                      0.53, 0.53, 0.53, 0.53, 0.53, 0.53,
                                      0.53, 0.53, 0.53, 0.53, 0.53, 0.53))

yu_smith_3 <- list("train" = list("words" = yu_smith_3_wo, 
                                  "objs" = yu_smith_3_wo), 
                   "Nsubj" = 40, 
                   "Condition" = "Yu_smith_3x3", 
                   "HumanItemAcc" = c(0.76, 0.76, 0.76, 0.76, 0.76, 0.76, 
                                      0.76, 0.76, 0.76, 0.76, 0.76, 0.76, 
                                      0.76, 0.76, 0.76, 0.76, 0.76, 0.76))

yu_smith_2 <- list("train" = list("words" = yu_smith_2_wo, 
                                  "objs" = yu_smith_2_wo), 
                   "Nsubj" = 40, 
                   "Condition" = "Yu_smith_2x2", 
                   "HumanItemAcc" = c(0.89, 0.89, 0.89, 0.89, 0.89, 0.89, 
                                      0.89, 0.89, 0.89, 0.89, 0.89, 0.89, 
                                      0.89, 0.89, 0.89, 0.89, 0.89, 0.89))


yu_smith_all <- list("two" = yu_smith_2, "three" = yu_smith_3, "four" = yu_smith_4,
                     "Condition" = "Yu Smith")
```

### Fit functions
```{r yu_smith_fit}

yu_smith_4_mod_fit <- fit_model("kachergis", yu_smith_4, 
                                c(.001,.1,.5), c(5,15,1), meanSSE)

yu_smith_3_mod_fit <- fit_model("kachergis", yu_smith_3, 
                                c(.001,.1,.5), c(5,15,1), meanSSE)

yu_smith_2_mod_fit <- fit_model("kachergis", yu_smith_2, 
                                c(.001,.1,.5), c(5,15,1), meanSSE)

```

```{r fit_all_yu_smith}
yu_smith_meanSSE <- function(par, order, human_perf) {
  mod2 = model(par, order$two$train)
  mod3 = model(par, order$three$train)
  mod4 = model(par, order$four$train)
  return(sum((mod2$perf-order$two$HumanItemAcc)^2) + 
           sum((mod3$perf-order$three$HumanItemAcc)^2) +
           sum((mod4$perf-order$four$HumanItemAcc)^2))
}
```

```{r yu_smith_fit_all}
yu_smith_mod_fit <- fit_model("kachergis", yu_smith_all, c(.001,.1,.5), c(5,15,1), yu_smith_meanSSE)
```

### Results
```{r yu_smith_result_fn}
yu_smith_get_results <- function(param2, param3, param4) {
  mod4 = run_model(yu_smith_4, param4)
  mod3 = run_model(yu_smith_3, param3)
  mod2 = run_model(yu_smith_2, param2)
  
  return(paste0(round(c(mean(mod4$perf), mean(mod3$perf), mean(mod2$perf)), 3), collapse=", "))
}
```

```{r yu_smith_results}
yu_smith_get_results(yu_smith_2_mod_fit, yu_smith_3_mod_fit, yu_smith_4_mod_fit)

yu_smith_get_results(yu_smith_mod_fit, yu_smith_mod_fit, yu_smith_mod_fit)
```


## Suanda et al 2014
We generated these inputs from the paper

### Input
```{r suanda_words_objs}
suanda_high_cd_wo <- matrix(c(2, 1, 4, 3, 6, 7, 8, 5, 
                           1, 3, 2, 4, 7, 5, 8, 6, 
                           2, 6, 3, 7, 1, 5, 4, 8, 
                           2, 3, 5, 6, 7, 8, 1, 4
                           ),
                         nrow = 16, ncol = 2, byrow = T)

suanda_med_cd_wo  <- matrix(c(2, 1, 8, 7, 3, 4, 5, 6, 
                           1, 3, 6, 7, 4, 2, 5, 8, 
                           2, 1, 7, 5, 3, 4, 6, 8, 
                           5, 6, 2, 3, 7, 8, 1, 4
                           ),
                         nrow = 16, ncol = 2, byrow = T)

suanda_low_cd_wo  <- matrix(c(2, 1, 7, 8, 5, 6, 3, 4, 
                           1, 2, 5, 7, 6, 8, 3, 4,
                           1, 3, 5, 6, 7, 8, 1, 2, 
                           3, 4, 5, 6, 2, 4, 7, 8
                           ),
                         nrow = 16, ncol = 2, byrow = T)
```

```{r suanda_test_input}
suanda_test_words <- matrix(c(
  1, 2, 3, 4, 5, 6, 7, 8
),
nrow = 8,
ncol = 1, byrow = T)

suanda_test_high <- matrix(c(
  1, 6, 7, 8,  2, 5, 7, 8,  3, 5, 6, 8,  4, 5, 6, 7,
  5, 2, 3, 4,  6, 1, 3, 4,  7, 1, 2, 4,  8, 1, 2, 3
),
nrow = 8,
ncol = 4, byrow = T)

suanda_test_med <- matrix(c(
  1, 5, 6, 7,  2, 5, 6, 8,  3, 6, 7, 8,  4, 5, 7, 8,
  5, 1, 2, 3,  6, 2, 3, 4,  7, 1, 2, 4,  8, 1, 3, 4
),
nrow = 8,
ncol = 4, byrow = T)

suanda_test_low <- matrix(c(
  1, 4, 5, 7,  2, 3, 6, 8,  3, 5, 7, 8,  4, 2, 3, 6,
  5, 2, 4, 7,  6, 1, 4, 8,  7, 1, 2, 6,  8, 1, 3, 5
),
nrow = 8,
ncol = 4, byrow = T)

```

```{r suanda_input}
suanda_high_cd <- list("train" = list("words" = suanda_high_cd_wo, 
                                      "objs" = suanda_high_cd_wo), 
                       "Nsubj" = 40, 
                       "Condition" = "Suanda_high_cd", 
                       "HumanItemAcc" = c(0.48, 0.48, 0.48, 0.48,
                                          0.48, 0.48, 0.48, 0.48))

suanda_med_cd <- list("train" = list("words" = suanda_med_cd_wo, 
                                     "objs" = suanda_med_cd_wo), 
                      "Nsubj" = 40, "Condition" = "Suanda_med_cd", 
                      "HumanItemAcc" = c(0.39, 0.39, 0.39, 0.39,
                                         0.39, 0.39, 0.39, 0.39))

suanda_low_cd <- list("train" = list("words" = suanda_low_cd_wo, 
                                     "objs" = suanda_low_cd_wo), 
                      "Nsubj" = 40, 
                   "Condition" = "Suanda_low_cd", 
                   "HumanItemAcc" = c(0.34, 0.34, 0.34, 0.34,
                                      0.34, 0.34, 0.34, 0.34))

suanda_expt <- list("high" = suanda_high_cd, 
                   "medium" = suanda_med_cd, 
                   "low" = suanda_low_cd, 
                   "Condition" = "Suanda")

```

### Fit functions
```{r suanda_sse_fn}
suanda_meanSSE_high <- function(par, order, human_perf) {
  mod = test_model(order, par, suanda_test_words, suanda_test_high, 16)
  return(sum((mod-unlist(order$HumanItemAcc))^2))
}

suanda_meanSSE_med <- function(par, order, human_perf) {
  mod = test_model(order, par, suanda_test_words, suanda_test_med, 16)
  return(sum((mod-unlist(order$HumanItemAcc))^2))
}

suanda_meanSSE_low <- function(par, order, human_perf) {
  mod = test_model(order, par, suanda_test_words, suanda_test_low, 16)
  return(sum((mod-unlist(order$HumanItemAcc))^2))
}

suanda_meanSSE <- function(par, order, human_perf) {
  return(sum(suanda_meanSSE_high(par, order$high, unlist(order$high$HumanItemAcc)),
             suanda_meanSSE_med(par, order$medium, unlist(order$medium$HumanItemAcc)),
             suanda_meanSSE_low(par, order$low, unlist(order$low$HumanItemAcc))))
}
```

```{r suanda_fit_all}
suanda_high_mod_fit <- fit_model("kachergis", suanda_high_cd, c(.001,.1,.5), c(5,15,1), 
                            suanda_meanSSE_high)
  
suanda_med_mod_fit <- fit_model("kachergis", suanda_med_cd, c(.001,.1,.5), c(5,15,1), 
                            suanda_meanSSE_med) 

suanda_low_mod_fit <- fit_model("kachergis", suanda_low_cd, c(.001,.1,.5), c(5,15,1), 
                            suanda_meanSSE_low) 

suanda_mod_fit <- fit_model("kachergis", suanda_expt, c(.001,.1,.5), c(5,15,1), 
                            suanda_meanSSE) 
```

```{r suanda_params}
suanda_high_mod_fit
suanda_med_mod_fit
suanda_low_mod_fit
suanda_mod_fit
```

### Results
```{r suanda_result_fn}
suanda_get_results <- function(high_par, med_par, low_par) {
  mod_high = test_model(suanda_high_cd, high_par, suanda_test_words, suanda_test_high, 16)
  mod_med = test_model(suanda_med_cd, med_par, suanda_test_words, suanda_test_med, 16)
  mod_low = test_model(suanda_low_cd, low_par, suanda_test_words, suanda_test_low, 16)
  return(list(round(c(mean(mod_high), mean(mod_med), mean(mod_low)), 3)))
}
```

```{r suanda_results}
suanda_get_results(suanda_high_mod_fit, suanda_med_mod_fit, suanda_low_mod_fit)
suanda_get_results(suanda_mod_fit, suanda_mod_fit, suanda_mod_fit)
```

### Range of possible results
```{r suanda_range}
min_high = 1
max_high = 0
min_med = 1
max_med = 0
min_low = 1
max_low = 0

suanda_values <- tibble(condition = c(), chi = c(), lambda = c(), alpha = c(), performance = c())
for(gamma in c(0.001, 0.01, 0.05, 0.1, 0.5, 1, 2, 3, 4, 5)) {
  for(lambda in c(0.1, 0.3, 0.5, 0.8, 1, 2, 3, 5, 10, 15)) {
    for(alpha in c(0.5, 0.6, 0.7, 0.8, 0.9, 0.92, 0.95, 0.96, 0.99, 1)) {
      high = suanda_get_results(c(gamma, lambda, alpha), c(gamma, lambda, alpha),
                   c(gamma, lambda, alpha))[[1]][1]
      if(high < min_high) {min_high = high}
      if(high > max_high) {max_high = high}
      if(high < 0.26 & high > 0.24) {
        print(c("high", gamma, lambda, alpha, high))
      }
      med = suanda_get_results(c(gamma, lambda, alpha), c(gamma, lambda, alpha),
                   c(gamma, lambda, alpha))[[1]][2]
      if(med < min_med) {min_med = med}
      if(med > max_med) {max_med = med}
      if(med < 0.26 & med > 0.24) {
        print(c("med", gamma, lambda, alpha, med))
      }
      low = suanda_get_results(c(gamma, lambda, alpha), c(gamma, lambda, alpha),
                   c(gamma, lambda, alpha))[[1]][3]
      if(low < min_low) {min_low = low}
      if(low > max_low) {max_low = low}
      if(low < 0.26 & low > 0.24) {
        print(c("low", gamma, lambda, alpha, low))
      }
      suanda_values <- rbind(suanda_values, 
                             tibble(condition = c("high", "med", "low"), 
                                    chi = c(gamma, gamma, gamma), 
                                    lambda = c(lambda, lambda, lambda), 
                                    alpha = c(alpha, alpha, alpha), 
                                    performance = c(high, med, low)))
    }
  }
}
min_high
max_high
min_med
max_med
min_low
max_low

suanda_values
```

```{r suanda_range_graph}
ggplot(data = suanda_values, aes(x=lambda, y = performance, color = condition)) +
  geom_point(aes(shape = condition)) +
  facet_grid(cols = vars(alpha), rows = vars(chi))
```

```{r suanda_tune_to_perfect}
# TODO
suanda_high_cd_perfect <- list("train" = suanda_high_cd_train, "Nsubj" = 40, 
                   "Condition" = "Suanda_high_cd", 
                   "HumanItemAcc" = c(0, 0, 0, 0, 0, 0, 0, 0))
```
# Experiments

## Expt 1

### Input
```{r expt1_input_words}
expt1_words <- matrix(c(51, 52, 43, 47, 43, 44, 48, 44, 45, 49, 45,
                        46, 50, 46, 53, 54, 55, 43, 56, 44, 51, 
                        52, 53, 45, 54, 46, 55, 56
                        ),
                        nrow = 28,
                        ncol=1, byrow=T
                        )

```

```{r expt1_input_recall_obj}

expt1_recall_obj <- matrix(c(39, 51, 40, 41, 
                      42, 52, 1, 2, 
                      16, 15, 43, 17, 
                      47, 27, 28, 29, NA, NA, NA, NA, 
                      44, 18, 19, 20, 
                      48, 30, 31, 32, NA, NA, NA, NA,
                      45, 21, 22, 23, 
                      49, 33, 34, 35, NA, NA, NA, NA,
                      46, 24, 25, 26, 
                      50, 36, 37, 38, NA, NA, NA, NA,
                      53, 3, 4, 5, 
                      54, 6, 7, 8, 
                      55, 9, 10, 11, NA, NA, NA, NA, 
                      56, 12, 13, 14, NA, NA, NA, NA,
                      51, 7, 1, 4, 
                      52, 33, 8, 10, 
                      53, 24, 14, 41, NA, NA, NA, NA, 
                      54, 10, 13, 16, NA, NA, NA, NA,
                      55, 19, 14, 47, 56, 25, 8, 28
                      ),
                    nrow = 28,
                    ncol=4, byrow=T
)

expt1_confirm_obj <- matrix(c(39, 51, 40, 41, 
                            42, 52, 1, 2, 
                            16, 15, 43, 17, 
                            47, 27, 28, 29,
                            43, 40, 1, 28, 
                            44, 18, 19, 20, 
                            48, 30, 31, 32, 
                            44, 31, 41, 2,
                            45, 21, 22, 23, 
                            49, 33, 34, 35, 
                            45, 34, 27, 1,
                            46, 24, 25, 26, 
                            50, 36, 37, 38, 
                            46, 36, 16, 31,
                            53, 3, 4, 5, 
                            54, 6, 7, 8, 
                            55, 9, 10, 11, 
                            43, 18, 22, 4, 
                            56, 12, 13, 14,  
                            44, 21, 5, 40,
                            51, 7, 1, 4, 
                            52, 33, 8, 10, 
                            53, 24, 14, 41, 
                            45, 36, 11, 2, 
                            54, 10, 13, 16, 
                            46, 13, 7, 11,
                            55, 19, 14, 47, 56, 25, 8, 28
),
nrow = 28,
ncol=4, byrow=T
)

```

```{r expt1_input}
expt1_recall <- list("train" = list("words" = expt1_words, 
                                    "objs" = expt1_recall_obj), 
                     "Nsubj" = 40, "Condition" = "Expt1 Recall",
                     "HumanItemAcc" = c(0.675, 0.825, 0.775, 0.700, 
                                        0.600, 0.500, 0.575, 0.5, 
                                        0.15, 0.05, 0.125, 0.025, 0.275, 0.175))
expt1_confirm_train <- 
expt1_confirm <- list("train" = list("words" = expt1_words, 
                                     "objs" = expt1_confirm_obj), 
                      "Nsubj" = 40, "Condition" = "Expt1 Confirm",
                      "HumanItemAcc" = c(0.90697674, 0.86046512, 0.88372093, 0.79069767, 
                                        0.53488372, 0.69767442, 0.58139535, 0.46511628, 
                                        0.02325581, 0.13953488, 0.02325581, 0.04651163, 0.23255814, 0.18604651 ))

expt1_input <- list("recall" = expt1_recall, "confirm" = expt1_confirm, "Condition" = "Expt 1")
```

### Test
```{r expt1_test}
expt1_test <- matrix(c(
  43, 15, 16, 17, 40, 18, 23, 46, 2,
  44, 18, 19, 20, 31, 21, 26, 49, 11,
  45, 21, 22, 23, 34, 36, 17, 56, 41,
  46, 24, 25, 26, 37, 14, 20, 51, 4,
  
  47, 27, 28, 29, 2, 7, 35, 36, 16,
  48, 30, 31, 32, 8, 11, 38, 42, 41,
  49, 33, 34, 35, 1, 4, 29, 43, 28,
  50, 36, 37, 38, 28, 14, 32, 55, 40,
  
  51, 39, 40, 41, 7, 1, 12, 44, 30,
  52, 42, 1, 2, 33, 26, 21, 48, 22,
  53, 3, 4, 5, 24, 14, 6, 47, 15,
  54, 6, 7, 8, 10, 16, 42, 53, 27,
  55, 9, 10, 11, 19, 5, 39, 54, 13,
  56, 54, 55, 14, 25, 28, 51, 3, 47
),
nrow = 14,
ncol = 9, byrow = T)
```

```{r expt1_test_fn}
test_model_expt1 <- function(expt, params) {
  mod = run_model(expt, params, print_perf=F)
  final_trajectory = mod$traj[28][[1]]

  test_performance = matrix(0, 1, 14)
  for(test_row in 1:nrow(expt1_test)) {
    test_options = as.integer(expt1_test[test_row,])
    numerator = final_trajectory[test_row+42, test_options[1]]
    denominator = 0
    for(option in test_options) {
      denominator = denominator + final_trajectory[test_row+42, option]
    }
    test_performance[1,test_row] = numerator / denominator
  }
                      
  return(test_performance)
}
```

### Fit model

```{r expt1_fit_model}
meanSSE_expt1_condition <- function(par, order, human_perf) {
  mod = test_model_expt1(order, par)
  return(sum((mod-human_perf)^2))
}

fit_model_expt1_condition <- function(model_name, order, par_lower, par_upper) {
  par_init = (par_lower + par_upper) / 2
  startt = Sys.time()
  cat("Model\tOrder\tSSE\tParameters\n")
  for(test_row in 1:10) { 
    best <- psoptim(par_init, meanSSE_expt1_condition, ord=order, human_perf=unlist(order$HumanItemAcc),
                    lower=par_lower, upper=par_upper)
  
    cat(model_name,'\t',order$Condition,'\t',best$value,'\t',best$par,'\n')
  }
  stopt = Sys.time()
  print(stopt-startt)
}

meanSSE_expt1 <- function(par, order, human_perf) {
  mod_confirm = test_model_expt1(order$confirm, par)
  mod_recall = test_model_expt1(order$recall, par)
  
  return(sum((mod_confirm - order$confirm$HumanItemAcc)^2) + 
           sum(mod_recall - order$recall$HumanItemAcc)^2)
}

fit_model_expt1 <- function(model_name, order, par_lower, par_upper) {
  par_init = (par_lower + par_upper) / 2
  startt = Sys.time()
  cat("Model\tOrder\tSSE\tParameters\n")
  for(test_row in 1:10) { 
    best <- psoptim(par_init, meanSSE_expt1, ord=order, 
                    human_perf=unlist(order$recall$HumanItemAcc),
                    lower=par_lower, upper=par_upper)
  
    cat(model_name,'\t',order$Condition,'\t',best$value,'\t',best$par,'\n')
  }
  stopt = Sys.time()
  print(stopt-startt)
}
```

```{r fit_expt1}
expt1_confirm_fit <- fit_model_expt1_condition("kachergis", expt1_confirm, c(.001,.1,.5), c(5,15,1))
expt1_recall_fit <- fit_model_expt1_condition("kachergis", expt1_recall, c(.001,.1,.5), c(5,15,1))
expt1_fit <- fit_model_expt1("kachergis", expt1_input, c(.001, .1, .5), c(5, 15, 1))

```

```{r run_expt1}
expt1_confirm_fubg <- test_model_expt1(expt1_confirm, 
                                       c(0.1308011, 0.1, 0.9214806))
expt1_recall_fubg <- test_model_expt1(expt1_recall, 
                                      c(3.369119, 6.154075, 0.7255642))
expt1_fubg_confirm <- test_model_expt1(expt1_confirm, c(5, 8.050791, 1))
expt1_fubg_recall <- test_model_expt1(expt1_recall, c(5, 8.050791, 1))
```

```{r expt1_fubg_results}
paste0(round(c(mean(expt1_confirm_fubg[1,1:4]),
               mean(expt1_confirm_fubg[1,5:8]),
               mean(expt1_confirm_fubg[1,9:14])),
             4), collapse=", ")

paste0(round(c(mean(expt1_recall_fubg[1,1:4]),
               mean(expt1_recall_fubg[1,5:8]),
               mean(expt1_recall_fubg[1,9:14])),
             4), collapse=", ")

paste0(round(c(mean(expt1_fubg_confirm[1,1:4]),
               mean(expt1_fubg_confirm[1,5:8]),
               mean(expt1_fubg_confirm[1,9:14])),
             4), collapse=", ")

paste0(round(c(mean(expt1_fubg_recall[1,1:4]),
               mean(expt1_fubg_recall[1,5:8]),
               mean(expt1_fubg_recall[1,9:14])),
             4), collapse=", ")
```

## Expt 3

### Input
```{r expt3_input_words}
expt3_words <- matrix(c(63, 64, 65, 66, 67,
                        68, 69, 70, 71, 72,
                        59, 60, 61, 62,
                        59, 60, 61, 62,
                        59, 60, 61, 62,
                        63, 64, 65, 66, 67,
                        68, 69, 70, 71, 72,
                        63, 64, 65, 66, 67,
                        68, 69, 70, 71, 72
                        ),
                        nrow = 42,
                        ncol=1, byrow=T
                        )
```

```{r expt3_input_ppa_obj}
expt3_ppa_obj <- matrix(c(31, 63, 30, 29, 34, 64, 33, 32, 
                          37, 65, 36, 35, 40, 66, 39, 38,
                          43, 67, 42, 41, 46, 68, 45, 44, 
                          49, 69, 48, 47, 52, 70, 51, 50,
                          55, 71, 54, 53, 58, 72, 57, 56,
                          
                          59, 7, 6, 5, 60, 14, 13, 12,
                          61, 21, 20, 19, 62, 28, 27, 26,
                          
                          59, 30, 33, 36, 60, 39, 42, 45,
                          61, 48, 51, 54, 62, 57, 29, 32,
                          
                          4, 3, 2, 1, 11, 10, 9, 8, 
                          18, 17, 16, 15, 25, 24, 23, 22, 
                          
                          63, 3, 38, 41, 64, 44, 23, 17,
                          65, 16, 56, 4, 66, 11, 18, 25,
                          67, 47, 10, 50, 68, 24, 2, 9,
                          69, 53, 35, 1, 70, 8, 14, 22,
                          71, 14, 30, 41, 72, 28, 44, 20,
                          
                          63, 48, 13, 7, 64, 6, 51, 4,
                          65, 20, 57, 54, 66, 6, 56, 50,
                          67, 47, 27, 12, 68, 36, 11, 27,
                          69, 18, 5, 33, 70, 26, 19, 12, 
                          71, 20, 38, 29, 72, 53, 44, 25
                      ),
                    nrow = 42,
                    ncol=4, byrow=T
)

```

```{r expt3_input_app_obj}
expt3_app_obj <- matrix(c(31, 63, 30, 29, 34, 64, 33, 32, 
                          37, 65, 36, 35, 40, 66, 39, 38,
                          43, 67, 42, 41, 46, 68, 45, 44, 
                          49, 69, 48, 47, 52, 70, 51, 50,
                          55, 71, 54, 53, 58, 72, 57, 56,
                          
                          4, 3, 2, 1, 11, 10, 9, 8, 
                          18, 17, 16, 15, 25, 24, 23, 22, 
                          
                          59, 7, 6, 5, 60, 14, 13, 12,
                          61, 21, 20, 19, 62, 28, 27, 26,
                          
                          59, 30, 33, 36, 60, 39, 42, 45,
                          61, 48, 51, 54, 62, 57, 29, 32,
                          
                          63, 3, 38, 41, 64, 44, 23, 17,
                          65, 16, 56, 4, 66, 11, 18, 25,
                          67, 47, 10, 50, 68, 24, 2, 9,
                          69, 53, 35, 1, 70, 8, 14, 22,
                          71, 14, 30, 41, 72, 28, 44, 20,
                          
                          63, 48, 13, 7, 64, 6, 51, 4,
                          65, 20, 57, 54, 66, 6, 56, 50,
                          67, 47, 27, 12, 68, 36, 11, 27,
                          69, 18, 5, 33, 70, 26, 19, 12, 
                          71, 20, 38, 29, 72, 53, 44, 25
),
nrow = 42,
ncol=4, byrow=T
)

```

```{r expt3_input}
expt3_app_train <- list("words" = expt3_words, "objs" = expt3_app_obj)
expt3_app <- list("train" = expt3_app_train, "Nsubj" = 40, "Condition" = "Conflict-first",
              "HumanItemAcc" = c(# Filler
                                 0.25, 0.275, 0.275, 0.275, 0.225, 
                                 0.2, 0.25, 0.275, 0.125, 0.15,
                                 # Target
                                 0.45, 0.275, 0.225, 0.3))
expt3_ppa_train <- list("words" = expt3_words, "objs" = expt3_ppa_obj)
expt3_ppa <- list("train" = expt3_ppa_train, "Nsubj" = 40, "Condition" = "Confirm-first",
                     "HumanItemAcc" = c(# Filler
                                        0.268, 0.268, 0.268, 0.512, 0.268, 
                                        0.293, 0.390, 0.317, 0.220, 0.268,
                                        # Target
                                        0.292, 0.488, 0.317, 0.390))


```

### Test
```{r expt3_test}
expt3_test <- matrix(c(
  63, 31, 30, 29,  3, 38, 41, 48, 13,  7, 43, 61,
  64, 34, 33, 32, 44, 23, 17,  6, 51,  4, 67, 58,
  65, 37, 36, 35, 16, 56,  4, 20, 57, 54, 66, 55,
  66, 40, 39, 38, 11, 18, 25,  6, 56, 50, 59, 71,
  67, 43, 42, 41, 47, 10, 50, 47, 27, 12, 64, 31,
  68, 46, 45, 44, 24,  2,  9, 36, 11, 27, 60, 72,
  69, 49, 48, 47, 53, 35,  1, 18,  5, 33, 34, 62,
  70, 52, 51, 50,  8, 14, 22, 26, 19, 12, 37, 63,
  71, 55, 54, 53, 14, 30, 41, 20, 38, 29, 65, 70,
  72, 58, 57, 56, 28, 44, 20, 53, 44, 25, 40, 52,
  
  59,  7,  6,  5, 30, 33, 36,  4,  3,  2,  1, 68,
  60, 14, 13, 12, 39, 42, 45, 11, 10,  9,  8, 49,
  61, 21, 20, 19, 48, 51, 54, 18, 17, 16, 15, 69,
  62, 28, 27, 26, 57, 29, 32, 25, 24, 23, 22, 52
),
nrow = 14,
ncol = 12, byrow = T)
```

```{r expt3_test_fn}
test_model_expt3 <- function(expt, params) {
  mod = run_model(expt, params, print_perf=F)
  final_trajectory = mod$traj[42][[1]]

  test_performance = matrix(0, 1, 14)
  for(test_row in 1:nrow(expt3_test)) {
    test_options = as.integer(expt3_test[test_row,])
    numerator = final_trajectory[test_options[1], test_options[1]]
    denominator = 0
    for(option in test_options) {
      denominator = denominator + final_trajectory[test_options[1], option]
    }
    test_performance[1,test_row] = numerator / denominator
  }
                      
  return(test_performance)
}
```

### Fit model
```{r expt3_fit_model}
meanSSE_expt3 <- function(par, order, human_perf) {
  mod = test_model_expt3(order, par)
  return(sum((mod-human_perf)^2))
}

fit_model_expt3 <- function(model_name, order, par_lower, par_upper) {
  par_init = (par_lower + par_upper) / 2
  startt = Sys.time()
  cat("Model\tOrder\tSSE\tParameters\n")
  for(test_row in 1:10) { 
    best <- psoptim(par_init, meanSSE_expt3, ord=order, human_perf=unlist(order$HumanItemAcc), lower=par_lower, upper=par_upper) 
    
    cat(model_name,'\t',order$Condition,'\t',best$value,'\t',best$par,'\n')
  }
  stopt = Sys.time()
  print(stopt-startt)
}
```

```{r fit_expt3}
expt3_app_fit <- fit_model_expt3("kachergis", expt3_app, c(.001,.1,.5), c(5,15,1)) 

expt3_ppa_fit <- fit_model_expt3("kachergis", expt3_ppa, c(.001,.1,.5), c(5,15,1)) 
```

### Run model
```{r expt3_run_models}
run_expt3 <- function(app_param, ppa_param) {
  app <- test_model_expt3(expt3_app, app_param)
  ppa <- test_model_expt3(expt3_ppa, ppa_param)
  
  all <- c(mean(app[11:14]), mean(app[1:10]), mean(ppa[11:14]), mean(ppa[1:10]))
  print(paste0(round(app, 3), collapse=", "))
  print(paste0(round(ppa, 3), collapse=", "))
  print(paste0(round(all, 3), collapse=", "))
  return(paste0(round(all, 3), collapse=", "))
}

run_expt3(c(1.115341, 4.213643, 0.9088536), c(5, 6.193, 0.929))
run_expt3(c(5, 5.495327, 0.905484 ), c(5, 6.193, 0.929))
```

```{r expt3_fit_to_expt}
meanSSE_expt3_all <- function(par, order, human_perf) {
  ppa_mod = test_model_expt3(order$ppa, par)
  app_mod = test_model_expt3(order$app, par)
  return(sum((ppa_mod-order$ppa$HumanItemAcc)^2)+sum((app_mod-order$app$HumanItemAcc)^2))
}

fit_model_expt3_all <- function(model_name, order, par_lower, par_upper) {
  par_init = (par_lower + par_upper) / 2
  startt = Sys.time()
  cat("Model\tOrder\tSSE\tParameters\n")
  for(test_row in 1:10) { 
    best <- psoptim(par_init, meanSSE_expt3_all, ord=order, human_perf=unlist(order$ppa$HumanItemAcc), lower=par_lower, upper=par_upper) 
    
    cat(model_name,'\t',order$Condition,'\t',best$value,'\t',best$par,'\n')
  }
  stopt = Sys.time()
  print(stopt-startt)
}

expt3_all <- list("app" = expt3_app, "ppa" = expt3_ppa, "Condition" = "Expt 3")

expt3_fit <- fit_model_expt3_all("kachergis", expt3_all, c(.001,.1,.5), c(5,15,1)) 

```

```{r expt3}

run_expt3(c(5, 5.936, 0.919), c(5, 5.936, 0.919))
```

## Expt 4

### Input
```{r expt4_words}
expt4_words <- matrix(c(5, 6, 7, 8, 9, 10, 11, 12, 13, 14,
                        1, 2, 3, 4, 
                        1, 2, 3, 4, 
                        1, 2, 3, 4,
                        5, 6, 7, 8, 9, 10, 11, 12, 13, 14,
                        5, 6, 7, 8, 9, 10, 11, 12, 13, 14,
                        15, 16, 17, 18, 
                        15, 16, 17, 18,  
                        15, 16, 17, 18),
                      nrow = 54,
                      ncol=1, byrow=T
)

```

```{r expt4_obj}
# Same and switch are basically the same in the FUbG input,
# because there's one item that co-occurs all 3 times, one item
# that co-occurs twice, and the rest co-occur once.
expt4_obj <- matrix(c(5, 35, 36, 37,  6, 39, 40, 41,  
                     7, 43, 44, 45,  8, 47, 48, 49,
                     9, 51, 52, 53,  10, 55, 56, 57,  
                     11, 59, 60, 61,  12, 63, 64, 65, 
                     13, 67, 68, 69,  14, 71, 72, 73,  
                       
                     1, 19, 20, 21,  2, 23, 24, 25,  
                     3, 27, 28, 29,  4, 31, 32, 33,
                     1, 19, 30, 24,  2, 23, 22, 33,  
                     3, 27, 34, 21,  4, 31, 26, 29,
                     1, 27, 33, 26,  2, 19, 29, 34,  
                     3, 31, 24, 22,  4, 23, 20, 30,
                     
                     5, 36, 62, 57,  6, 40, 70, 61,   
                     7, 44, 54, 73,  8, 48, 42, 65,
                     9, 52, 66, 45,  10, 56, 38, 69,  
                     11, 60, 50, 41,  12, 64, 46, 49,
                     13, 68, 74, 37,  14, 72, 58, 53,
                     
                     5,  48, 69, 54,  6, 44, 53, 58,   
                     7, 36, 41, 50,  8, 52, 37, 46, 
                     9, 40, 61, 74,  10, 72, 45, 62,  
                     11, 64, 73, 70,  12, 68, 57, 42,
                     13, 56, 49, 66,  14, 60, 65, 38,
                       
                     15, 75, 76, 77,  16, 79, 80, 81,  
                     17, 83, 84, 85,  18, 87, 88, 89,
                     15, 75, 86, 80,  16, 79, 78, 88,  
                     17, 83, 90, 76,  18, 87, 82, 84,
                     15, 83, 88, 78,  16, 75, 84, 90,  
                     17, 87, 80, 78,  18, 83, 76, 86
                           ),
                      nrow = 54,
                      ncol=4, byrow=T
)

```

```{r expt4_input}
expt4_train <- list("words" = expt4_words, "objs" = expt4_obj)
expt4_input <- list("train" = expt4_train, "Nsubj" = 40,
                           "switch_human" = c(0.35, 0.575, 0.3, 0.275, 
                                 0.35, 0.425, 0.425, 0.4, 0.35, 
                                 0.275, 0.475, 0.475, 0.55, 0.425, 
                                 0.275, 0.325, 0.4, 0.55
                                 ),
                           "same_human" = c(0.585, 0.488, 0.756, 0.683, 
                                 0.415, 0.512, 0.39, 0.854, 0.61, 
                                 0.317, 0.902, 0.878, 0.488, 0.341, 
                                 0.39, 0.439, 0.61, 0.854
                                 ),
                    "Condition" = "Toilet")
```

### Test
```{r expt4_test}
expt4_test_obj_same <- matrix(c(
  15, 75, 86, 82, 60, 33,  5, 10, 44,
  16, 79, 78, 90, 64,  6, 48, 11, 59,
  17, 83, 90, 78, 68, 49, 53, 32, 12,
  18, 87, 82, 86, 72, 41, 57, 13, 67,
  
   5, 35, 62, 54, 20, 45, 63, 15, 71,
   6, 39, 70, 58, 24, 60, 68, 16, 17,
   7, 43, 54, 50, 28, 55, 14, 84, 69,
   8, 47, 42, 38, 32, 25, 20, 21, 52,
   9, 51, 66, 90, 76,  1, 72, 39, 27,
  10, 55, 38, 62, 80, 49, 29, 75, 89,
  11, 59, 50, 70, 84, 31, 23, 43, 87,
  12, 63, 46, 42, 88,  3, 35, 79, 24,
  13, 67, 74, 66, 36, 19, 28, 51, 88,
  14, 71, 58, 38, 40,  4, 47, 76, 81,
  
   1, 19, 30, 26, 44,  9, 65, 80, 18,
   2, 23, 22, 34, 48, 36, 56, 77, 83,
   3, 27, 34, 22, 52, 61, 37, 73,  2,
   4, 31, 26, 30, 56, 40, 64,  7, 85
  ),
  nrow = 18,
  ncol = 9, byrow = T)

expt4_test_obj_switch <- matrix(c(
  15, 75, 86, 82, 60, 33,  5, 10, 44,
  16, 79, 78, 90, 64,  6, 48, 11, 59,
  17, 83, 90, 78, 68, 49, 53, 32, 12,
  18, 87, 82, 86, 72, 41, 57, 13, 67,
  
   5, 35, 62, 54, 20, 45, 63, 75, 71,
   6, 39, 70, 58, 24, 60, 68, 16, 83,
   7, 43, 54, 50, 28, 55, 14, 84, 69,
   8, 47, 42, 38, 32, 25, 20, 21, 52,
   9, 51, 66, 90, 76, 19, 72, 39,  3,
  10, 55, 38, 62, 80, 49, 29, 15, 89,
  11, 59, 50, 70, 84, 31,  2, 43, 18,
  12, 63, 46, 42, 88, 27, 35, 79, 24,
  13, 67, 74, 66, 36,  1, 28, 51, 88,
  14, 71, 58, 38, 40,  4, 47, 76, 81,
  
   1, 19, 30, 26, 44,  9, 65, 80, 87,
   2, 23, 22, 34, 48, 36, 56, 77, 17,
   3, 27, 34, 22, 52, 61, 37, 73, 23,
   4, 31, 26, 30, 56, 40, 64,  7, 85
  ),
  nrow = 18,
  ncol = 9, byrow = T)
```

```{r expt4_test_fn}
test_model_expt4 <- function(expt, params, same=T) {
  mod = run_model(expt, params, print_perf=F)
  final_trajectory = mod$traj[54][[1]]

  test_performance = matrix(0, 1, 18)
  for(test_row in 1:18) {
    if(same == TRUE) {
      test_options = as.integer(expt4_test_obj_same[test_row,])
    } else {
      test_options = as.integer(expt4_test_obj_switch[test_row,])
    }
    
    numerator = final_trajectory[test_options[1], test_options[1]]
    denominator = 0
    for(option in test_options) {
      denominator = denominator + final_trajectory[test_options[1], option]
    }
    test_performance[1,test_row] = numerator / denominator
  }
                      
  return(test_performance)
}

```

### Fit
```{r expt4_fit_fn}
meanSSE_expt4_same <- function(par, order, human_perf) {
  mod = test_model_expt4(order, par, same=TRUE)
  return(sum((mod-human_perf)^2))
}

meanSSE_expt4_switch <- function(par, order, human_perf) {
  mod = test_model_expt4(order, par, same=FALSE)
  return(sum((mod-human_perf)^2))
}

meanSSE_expt4 <- function(par, order, human_perf) {
  mod_same = test_model_expt4(order, par, same=TRUE)
  mod_switch = test_model_expt4(order, par, same=FALSE)
  return(sum((mod_same-order$same_human)^2)+
           sum((mod_switch-order$switch_human)^2))
}

fit_model_expt4 <- function(model_name, order, par_lower, par_upper, same=TRUE, expt=FALSE) {
  par_init = (par_lower + par_upper) / 2
  startt = Sys.time()
  cat("Model\tOrder\tSSE\tParameters\n")
  for(test_row in 1:10) { 
    if(expt == TRUE) {
      best <- psoptim(par_init, 
                      meanSSE_expt4, 
                      ord=order,
                      human_perf=unlist(order$same_human),
                      lower=par_lower, upper=par_upper) 
    } else{
      if(same == TRUE) {
        best <- psoptim(par_init, 
                        meanSSE_expt4_same, 
                        ord=order,
                        human_perf=unlist(order$same_human),
                        lower=par_lower, upper=par_upper) 
      } else {
        best <- psoptim(par_init, 
                        meanSSE_expt4_switch, 
                        ord=order,
                        human_perf=unlist(order$switch_human),
                        lower=par_lower, upper=par_upper) 
        
      }
    }
    
    cat(model_name,'\t',"expt 4",'\t',best$value,'\t',best$par,'\n')
  }
  stopt = Sys.time()
  print(stopt-startt)
}

```

```{r expt4_fit}
expt4_same_fit <- fit_model_expt4("kachergis", expt4_input, c(.001,.1,.5), c(5,15,1), same=TRUE, expt=FALSE) 

expt4_switch_fit <- fit_model_expt4("kachergis", expt4_input, c(.001,.1,.5), c(5,15,1), same=FALSE, expt=FALSE) 

expt4_fit <- fit_model_expt4("kachergis", expt4_input, c(.001,.1,.5), c(5, 15, 1), same=FALSE, expt=TRUE)
```

### Run models
```{r expt4_run_fn}
run_expt4 <- function(same_param, switch_param) {
  same <- test_model_expt4(expt4_input, same_param)
  switch <- test_model_expt4(expt4_input, switch_param)
  
  all <- c(mean(same[1:4]), mean(same[15:18]), mean(same[5:14]),
           mean(switch[1:4]), mean(switch[15:18]), mean(switch[5:14]))
  print(paste0(round(same, 3), collapse=", "))
  print(paste0(round(switch, 3), collapse=", "))
  return(paste0(round(all, 3), collapse=", "))
}

```

```{r expt4_run}
print("tuned to each condition")
run_expt4(c(0.140, 0.1, 0.895), c(0.0467, 0.1, 0.975))

print("tuned to expt")
run_expt4(c(0.0765, 0.1, 0.936),c(0.0765, 0.1, 0.936))
```


---
title: "recall_analysis"
author: "Christine Soh Yue"
date: "2025-01-13"
output: html_document
---

# Set-up and libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r library, results=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(ggplot2)
library(ggpattern)
library(lme4)
library(lmerTest)
library(ggsignif)
library(TeachingDemos)
library(penngradlings)

theme_set(theme_pgl_minimal())

# theme_set(theme_minimal())

`%!in%` <- Negate(`%in%`)

c2 <- contr.treatment(2)
coding2 <- matrix(rep(1/2, 2), ncol=1)
simple2 <- c2-coding2


```

# Models

```{r pursuit}
expt1_fubg_pred <- tibble(
  "condition" = c("Confirm", "Confirm", "Confirm", "Retrieval", "Retrieval", "Retrieval",
                  "Confirm", "Confirm", "Confirm", "Retrieval", "Retrieval", "Retrieval"
                  ), 
  "word_type_graph" = c("Target: Confirm", "One-shot", "Filler", "Target: Retrieval", "One-shot", "Filler",
                        "Target: Confirm", "One-shot", "Filler", "Target: Retrieval", "One-shot", "Filler"
                        ), 
  "count" = c(1, 1, 1, 1, 1, 1,
              1, 1, 1, 1, 1, 1), 
  "mean_acc" = c(0.5736, 0.2175, 0.38,
                 0.156, 0.2485, 0.188,
                 0.6636, 0.2486, 0.4618,
                 0.2475, 0.2486, 0.6267
                 ), 
  "sd_acc" = c(0, 0, 0, 0, 0, 0,
               0, 0, 0, 0, 0, 0), 
  "se" = c(0, 0, 0, 0, 0, 0,
           0, 0, 0, 0, 0, 0), 
  "expt" = c("FUb", "FUb", "FUb", "FUb", "FUb", "FUb",
             "FUb-fixed", "FUb-fixed", "FUb-fixed", 
             "FUb-fixed", "FUb-fixed", "FUb-fixed")
)

expt1_might_pred <- read_csv("../model_code/results/might_expt1_2_results.csv") %>%
  mutate(
    expt = "MIGHT"
  ) %>%
  rbind(mutate(read_csv("../model_code/results/might_11_expt1_2_results.csv"), expt = "MIGHT\n(larger memory)")) %>%
  rbind(mutate(read_csv("../model_code/results/pursuit_expt1_2_results.csv"), expt = "Pursuit")) %>%
  filter(
    phase == "testing"
  ) %>%
  mutate(
    condition = case_when(
      condition %in% c("recall", "Retrieval") ~ "Retrieval",
      condition %in% c("confirm", "Confirm") ~ "Confirm"
    ),
    word_type_graph = case_when(
      word %in% c("R1", "R2", "R3", "R4") & condition == "Retrieval" ~ "Target: Retrieval",
      word %in% c("R1", "R2", "R3", "R4") & condition == "Confirm" ~ "Target: Confirm",
      word %in% c("W1", "W2", "W3", "W4") ~ "One-shot",
      TRUE ~ "Filler"
    )
  ) %>%
  group_by(expt, condition, word_type_graph) %>%
  summarise(
    count = n(),
    mean_acc = mean(accuracy),
    sd_acc = sd(accuracy),
    se = sd_acc / sqrt(count)
  ) %>%
  ungroup() 

expt1_model_pred <- expt1_fubg_pred %>%
  rbind(expt1_might_pred)

expt1_model_plot <- ggplot(data = filter(expt1_model_pred
                     ), aes(x=condition, y=mean_acc, fill = word_type_graph)) +
  geom_col_pattern(position="dodge", pattern="stripe") +
  facet_grid(col = vars(expt)) +
  labs(y = "Accuracy at test") +
  theme(
    legend.position = "bottom"
  ) +
  scale_fill_manual(values=
                      # col2grey(
                        c("#5f1c99", "#b2abd2", "#e66101", "#fbd863")
                        # )
                    ) +
  geom_errorbar(aes(x=condition, ymin=mean_acc+se,
                    ymax=mean_acc-se),
                width=.3,
                position=position_dodge(.9)) +
  geom_hline(aes(yintercept = 1/9), linetype = "dashed") +
  ylim(0, 1)

expt1_model_plot
```

# Experiment 1

```{r expt1_data}
expt1_raw_data <- read_csv("expt1_data.csv") %>%
  mutate(expt = 1)

expt1_excluded_participants <- expt1_raw_data %>%
  filter(
    phase == "debrief",
    (item == "Cheat" & input != "My data is good") | (item == "WriteDown") & grepl("yes", input)
  ) %>%
  select(
    id, condition, item, input
  )

expt1_excluded_participants

expt1_data <- expt1_raw_data %>%
  filter(id %!in% expt1_excluded_participants$id)
  
```

```{r expt1_counts}
expt1_data %>%
  group_by(condition) %>%
  summarise(
    count = n_distinct(id)
  )
```

```{r expt1_by_item}
expt1_data %>%
  filter(
    phase == "test"
  ) %>%
  group_by(condition, item, word_type) %>%
  summarize(acc = mean(target_selected))
  
```

## Testing
```{r expt1_testing_selections}
expt1_test_selections <- expt1_data %>%
  filter(
    phase == "test"
  ) %>%
  mutate(
    accuracy = as.integer(target_selected),
    condition = factor(condition),
    word_type = factor(word_type, levels = c("target", "one-shot", "filler")),
    word_type_graph = factor(case_when(
      word_type == "filler" ~ "Filler",
      word_type == "target" ~ paste("Target:", condition),
      word_type == "one-shot" ~ "One-shot",
      TRUE ~ word_type
    ), levels=c("Target: Confirm", "Target: Recall", "One-shot", "Filler"))
  )

expt1_by_word <- expt1_test_selections %>%
  group_by(
    condition, word_type_graph, word
  ) %>%
  summarise(
    count = n(),
    mean_acc = mean(accuracy),
    sd_acc = sd(accuracy),
    se = sd_acc / sqrt(count)
  ) %>%
  ungroup() %>%
  mutate(
    expt = "Expt 1"
  )


expt1_aggr_test_selections <- expt1_test_selections %>%
  group_by(
    condition, word_type_graph
  ) %>%
  summarise(
    count = n(),
    mean_acc = mean(accuracy),
    sd_acc = sd(accuracy),
    se = sd_acc / sqrt(count)
  ) %>%
  ungroup() %>%
  mutate(
    expt = "Expt 1"
  )

expt1_plot <- ggplot(filter(expt1_aggr_test_selections, word_type_graph != "Foil"), aes(x=condition, y=mean_acc, fill=word_type_graph)) +
  geom_col(position="dodge") +
  scale_fill_manual(values=
                      # col2grey(
                        c("#5f1c99", "#b2abd2", "#e66101", "#fbd863")
                        # )
                    ) +
  ylim(0, 1) +
  labs(
      x = "Experimental Condition",
      y = "Accuracy at test",
      fill = "Word type"
    ) +
  geom_errorbar(aes(x=condition, ymin=mean_acc+se,
                    ymax=mean_acc-se),
                width=.2,
                position=position_dodge(.9)) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        legend.title=element_text(size=16, face="bold"),
        legend.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        strip.text.x = element_text(size = 14)
        ) +
  geom_signif(y_position = c(0.95,0.85), xmin = c(0.8,1.8),
              xmax = c(1.2,2.2), annotation = c("***","***"),
              tip_length = 0) +
  geom_hline(yintercept=(1/9), linetype='dotted') 

expt1_plot

```

### Statistical analysis
```{r expt1_testing_model}
expt1_test_model_data <- expt1_test_selections %>%
  mutate(
    condition = factor(condition, levels = c("Recall", "Confirm")),
    word_type = factor(word_type, levels = c("one-shot", "target", "filler")),
    noun = factor(item),
    offset = 1/9
  ) %>%
  filter(
    word_type != "filler"
  ) %>%
  mutate(
    word_type = factor(word_type, levels = c("one-shot", "target"))
  )



c2 <- contr.treatment(2)
coding2 <- matrix(rep(1/2, 2), ncol=1)
simple2 <- c2-coding2

simple2

contrasts(expt1_test_model_data$condition) <- simple2
contrasts(expt1_test_model_data$word_type) <- simple2

expt1_model <- glmer(accuracy ~ word_type * condition + offset(log(offset/(1 - offset))) + (1 + word_type | id),
               data=expt1_test_model_data, family="binomial", control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(expt1_model)
```

```{r expt1_model_within_conditions}

expt1_recall_model <- glmer(accuracy ~ word_type + offset(qlogis(offset)) + (1 | id),
               data=filter(expt1_test_model_data, condition == "Recall"), family="binomial", 
               control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(expt1_recall_model)

expt1_confirm_model <- glmer(accuracy ~ word_type + offset(qlogis(offset)) + (1 | id),
               data=filter(expt1_test_model_data, condition == "Confirm"), family="binomial", 
               control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(expt1_confirm_model)

```


```{r expt1_fillers}
expt1_filler_model_data <- expt1_test_selections %>%
  mutate(
    condition = factor(condition, levels = c("Recall", "Confirm")),
    word_type = factor(word_type, levels = c("one-shot", "target", "filler")),
    noun = factor(item),
    offset = 1/9
  ) %>%
  filter(
    word_type == "filler"
  )

contrasts(expt1_filler_model_data$condition) <- simple2

expt1_filler_model <- glmer(accuracy ~ condition + offset(qlogis(offset)) + (1 | id),
               data=expt1_filler_model_data, family="binomial", 
               control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(expt1_filler_model)


```
# Experiment 2


```{r expt2_data}
expt2_raw_data <- read_csv("expt2_data.csv") %>%
  mutate(expt = 2)

expt2_excluded_participants <- expt2_raw_data %>%
  filter(
    phase == "debrief",
    (item == "Cheat" & input != "My data is good") | (item == "WriteDown") & grepl("yes", input)
  ) 

expt2_excluded_participants

expt2_data <- expt2_raw_data %>%
  filter(id %!in% expt2_excluded_participants$id)
  
```

```{r expt2_counts}
expt2_data %>%
  group_by(condition) %>%
  summarise(
    count = n_distinct(id)
  )
```
## Testing
```{r expt2_testing}
expt2_test_selections <- expt2_data %>%
  filter(
    phase == "test", 
  ) %>%
  mutate(
    accuracy = as.integer(target_selected),
    condition = factor(condition),
    word_type = factor(word_type, levels = c("target", "one-shot", "filler")),
    word_type_graph = factor(case_when(
      word_type == "filler" ~ "Filler",
      word_type == "target" ~ paste("Target:", condition),
      word_type == "one-shot" ~ "One-shot",
      TRUE ~ word_type
    ), levels=c("Target: Confirm", "Target: Recall", "One-shot", "Filler"))
  )

expt2_aggr_test_selections <- expt2_test_selections %>%
  group_by(
    condition, word_type_graph
  ) %>%
  summarise(
    count = n(),
    mean_acc = mean(accuracy),
    sd_acc = sd(accuracy),
    se = sd_acc / sqrt(count)
  ) %>%
  ungroup() %>%
  mutate(
    expt = "Expt 2"
  )

expt2_testing_plot <- ggplot(filter(expt2_aggr_test_selections, word_type_graph != "Foil"), aes(x=condition, y=mean_acc, fill=word_type_graph)) +
  geom_col(position="dodge") +
  scale_fill_manual(values=
                      # col2grey(
                        c("#5f1c99", "#b2abd2", "#e66101", "#fbd863")
                        # )
                    ) +
  ylim(0, 1) +
  labs(
      x = "Experimental Condition",
      y = "Accuracy at test",
      fill = "Word type"
    ) +
  geom_errorbar(aes(x=condition, ymin=mean_acc+se,
                    ymax=mean_acc-se),
                width=.2,
                position=position_dodge(.9)) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        legend.title=element_text(size=16, face="bold"),
        legend.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        strip.text.x = element_text(size = 14)
        ) +
  geom_signif(y_position = c(0.95,0.85), xmin = c(0.8,1.8),
              xmax = c(1.2,2.2), annotation = c("***","**"),
              tip_length = 0) +
  geom_hline(yintercept=(1/9), linetype='dotted') 

expt2_testing_plot
```

### Statistical analysis
```{r expt2_testing_model}
expt2_test_model_data <- expt2_test_selections %>%
  filter(word_type != "filler") %>%
  mutate(
    condition = factor(condition, levels = c("Recall", "Confirm")),
    word_type = factor(word_type, levels = c("one-shot", "target")),
    noun = factor(item),
    offset = 1/9
  )

contrasts(expt2_test_model_data$condition) <- simple2
contrasts(expt2_test_model_data$word_type) <- simple2

expt2_model <- glmer(accuracy ~ word_type * condition + offset(qlogis(offset)) + (1 + word_type | id),
               data=expt2_test_model_data, family="binomial", control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(expt2_model)
```

```{r expt2_model_within_conditions}

expt2_recall_model <- glmer(accuracy ~ word_type + offset(qlogis(offset)) + (1 | id),
               data=filter(expt2_test_model_data, condition == "Recall"), family="binomial", 
               control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(expt2_recall_model)

expt2_confirm_model <- glmer(accuracy ~ word_type + offset(qlogis(offset)) + (1 | id),
               data=filter(expt2_test_model_data, condition == "Confirm"), family="binomial", 
               control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(expt2_confirm_model)

```

```{r expt2_fillers}
expt2_filler_model_data <- expt2_test_selections %>%
  mutate(
    condition = factor(condition, levels = c("Recall", "Confirm")),
    word_type = factor(word_type, levels = c("one-shot", "target", "filler")),
    noun = factor(item),
    offset = 1/9
  ) %>%
  filter(
    word_type == "filler"
  )

contrasts(expt2_filler_model_data$condition) <- simple2

expt2_filler_model <- glmer(accuracy ~ condition + offset(qlogis(offset)) + (1 | id),
               data=expt2_filler_model_data, family="binomial", 
               control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(expt2_filler_model)


```




# Compare expt


```{r expt1_expt2_model}
expt1_2_recall_data <- expt2_test_selections %>%
  mutate(expt = 2) %>%
  rbind(select(expt1_test_selections, all_of(colnames(expt2_test_selections)))) %>%
  filter(condition == "Recall", word_type != "filler") %>%
  mutate(
    expt = factor(expt),
    word_type = factor(word_type, levels = c("one-shot", "target")),
    noun = factor(item),
    id = factor(id),
    offset = 1/9
  )

expt1_2_recall_model <- glmer(accuracy ~ expt * word_type + offset(qlogis(offset)) + (1 | id),
               data=expt1_2_recall_data, family="binomial", 
               control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

summary(expt1_2_recall_model)
```


```{r both_model}
expt1_2_all_test <- expt2_test_selections %>%
  mutate(expt = 2) %>%
  rbind(select(expt1_test_selections, all_of(colnames(expt2_test_selections)))) %>%
  filter(word_type != "filler") %>%
  mutate(
    expt = factor(expt),
    word_type = factor(word_type, levels = c("one-shot", "target")),
    noun = factor(item),
    id = factor(id)
  )

expt1_2_all_model <- glmer(accuracy ~ expt * word_type * condition + (1 | id),
               data=expt1_2_all_test, family="binomial", 
               control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

summary(expt1_2_all_model)
```

```{r aggregate}
expt1_2_results <- expt1_aggr_test_selections %>%
  rbind(expt2_aggr_test_selections) %>%
  mutate(
    participants = "human", 
    word_type_graph = factor(case_when(
      word_type_graph == "filler" ~ "Filler",
      word_type_graph == "Target: Recall" ~ "Target: Retrieval",
      TRUE ~ word_type_graph
    ), levels = c("Target: Confirm", "Target: Retrieval", "One-shot", "Filler")),
    condition = case_when(
      condition %in% c("Recall", "Retrieval") ~ "Retrieval",
      TRUE ~ condition
    )
  ) %>%
  rbind(mutate(expt1_model_pred, participants = "model")) %>%
  mutate(
    expt = factor(expt, levels = c(
      "MIGHT",
      "Pursuit", "FUb",
      "FUb-fixed",
      "Expt 1", "Expt 2",
      "MIGHT\n(larger memory)"
    )),
    word_type_graph = factor(case_when(
    word_type_graph == "One-shot" ~ "One-shot",
    word_type_graph == "Filler" ~ "Filler",
    TRUE ~ "Target"
    ), levels = c(
      "Target", "One-shot", "Filler"
    ))
  )

expt1_2_paper_plot <- ggplot(filter(expt1_2_results), aes(x=condition, y=mean_acc, fill=word_type_graph)) +
  geom_col_pattern(aes(pattern = participants), position="dodge") +
  scale_pattern_manual(values = c("wave", "stripe"), guide="none") +
  ylim(0, 1) +
  labs(
      x = "Experimental Condition",
      y = "Accuracy at test",
      fill = "Word type"
    ) +
  facet_wrap(vars(expt), nrow = 2, scales="free_x") +
  geom_errorbar(aes(x=condition, ymin=mean_acc+se,
                    ymax=mean_acc-se),
                width=.2,
                position=position_dodge(.9)) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        legend.title=element_text(size=16, face="bold"),
        legend.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        strip.text.x = element_text(size = 14),
        legend.position = "bottom"
        ) +
  scale_fill_manual(values=
                      # col2grey(
                        c("#5f1c99", 
                          # "#b2abd2", 
                          "#e66101", "#fbd863")
                        # )
                    ) +
  geom_hline(yintercept=(1/9), linetype='dotted') 

expt1_2_paper_plot
ggsave("expt1_test.png", width=8, height=6, units="in", dpi="print")
```

# Expt 1 and 2 Learning
## Expt 1 learning
```{r expt1_learning}
expt1_learning_selections <- expt1_data %>%
  filter(phase == "learning") %>%
  group_by(
    condition, id, word, word_type
  ) %>%
  summarise(
    num_selections = sum(target_selected),
    item = min(item),
    input = paste0(input, collapse = ""),
    selection = paste0(input, collapse = "")
  )

expt1_aggr_learning_selections <-  expt1_data %>%
  filter(phase == "learning") %>%
  group_by(
    condition, word_type, exposure
  ) %>%
  summarise(
    n = n(),
    mean = mean(target_selected),
    sd = sd(target_selected),
    se = sd / sqrt(n)
  )

ggplot(data = filter(expt1_aggr_learning_selections, word_type == "target"), aes(x = exposure, y = mean, fill = condition)) +
  geom_col(position="dodge") +
  scale_fill_manual(values=
                      # col2grey(
                        c("#5f1c99", "#b2abd2", "#e66101", "#fbd863")
                        # )
                    ) +
  facet_grid(cols = vars(condition)) +
  geom_errorbar(aes(x=exposure, ymin=mean+se,
                    ymax=mean-se),
                width=.2,
                position=position_dodge(.9)) +
  guides(fill = "none")
```

### Typed responses
```{r expt1_typed_responses}
expt1_typed_responses <- expt1_data %>%
  filter(
    phase == "learning"
  ) 

expt1_typed_responses %>%
  filter(
    selected_object != "0"
  ) %>%
  group_by(word_type, 
           condition) %>%
  mutate(
    total = n()
  ) %>%
  ungroup() %>%
  group_by(selection_matches_guess, 
           word_type,
           condition, total) %>%
  summarise(
    count = n()
  ) %>%
  ungroup() %>%
  mutate(
    proportion = count / total,
    word_type = factor(case_when(
      word_type == "target" ~ "Target",
      word_type == "one-shot" ~ "One-shot",
      word_type == "filler" ~ "Filler"
    ), levels=c("Target", "One-shot", "Filler")),
    word_type_graph = factor(case_when(
      word_type == "Target" & condition == "Confirm" ~ "Target: Confirm",
      word_type == "Target" & condition == "Recall" ~ "Target: Recall",
      TRUE ~ word_type
    ), levels=c("Target: Confirm", "Target: Recall", "One-shot", "Filler"))
  ) %>%
  select(
    condition, word_type_graph, 
    selection_matches_guess,
    proportion, total 
  ) %>%
  pivot_wider(
    names_from = selection_matches_guess,
    values_from = proportion
  ) %>%
  mutate(
    `superordinate match` = superordinate + `exact match`
  ) %>%
  select(!superordinate)
```

```{r expt1_typed_learning}
expt1_typed_learning <- expt1_typed_responses %>%
  mutate(
    index = paste(id, word)
  )

expt1_first <- expt1_typed_learning %>%
  filter(exposure == 1, word_type != "Filler")

expt1_got_first_correct <- expt1_typed_learning %>%
  filter(exposure == 1, edited_input != "other", selection_matches_guess > 0,
         word_type != "Filler"
         )

expt1_aggr_typed_learning <- expt1_typed_learning %>%
  filter(index %in% expt1_got_first_correct$index, word_type == "target") %>%
  group_by(word_type, 
           exposure,
           condition) %>%
  summarise(
    n = n(),
    mean = mean(typed_accuracy),
    sd = sd(typed_accuracy),
    se = sd / sqrt(n)
  ) %>%
  ungroup() %>%
  select(
    condition, word_type, exposure,
    n, mean, sd, se
  ) 

ggplot(data = filter(expt1_aggr_typed_learning), aes(x=exposure, y=mean,
                                                  fill = condition)) +
  geom_col(position = "dodge") +
  facet_wrap(~condition) + 
  labs(
      x = "Exposure",
      y = "Accuracy in typed response",
      fill = "Word type"
    ) +
  scale_fill_manual(values=
                      # col2grey(
                        c("#5f1c99", "#b2abd2", "#e66101", "#fbd863")
                        # )
                    ) +
  scale_pattern_manual(values = c("stripe", "wave")) + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        legend.title=element_text(size=16, face="bold"),
        legend.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        strip.text.x = element_text(size = 14),
        ) +
  geom_errorbar(aes(x=exposure, ymin=mean+se,
                    ymax=mean-se),
                width=.2,
                position=position_dodge(.9)) +
  guides(fill = "none")

```


Are participants selecting form their initial hypotheses from Exposure 1?

```{r expt1_first_hypotheses}
expt1_first_hypotheses <- expt1_typed_learning %>%
  filter(
    item %in% c(3, 4, 6, 7, 9, 10, 12, 13, 1, 2, 15, 16, 17, 19)
  ) %>%
  mutate(
    index = paste(id, word),
    hyp_id = paste(id, selected_object),
    hyp_typed_id = paste(id, edited_input)
  ) %>%
  select(id, hyp_id, hyp_typed_id)
```

```{r typed_guesses_from_hypotheses}
expt1_learning_typed_from_hyp <- expt1_typed_learning %>%
  mutate(
    selection_index = paste(id, selected_object),
    selected_item_from_hyp = case_when(
      selected_object != "0" ~ as.integer(selection_index %in% expt1_first_hypotheses$hyp_id),
      TRUE ~ 1
    ),
    exact_typed_index = paste(id, edited_input),
    typed_from_hyp = as.integer(exact_typed_index %in% expt1_first_hypotheses$hyp_typed_id)
  )

expt1_learning_hypotheses <- expt1_learning_typed_from_hyp %>%
  group_by(word_type, exposure, condition) %>%
  summarise(
    mean_selection_from_hyp = mean(selected_item_from_hyp, na.rm=TRUE),
    mean_typed_from_hyp = mean(typed_from_hyp),
    sd_selection_from_hyp = sd(selected_item_from_hyp, na.rm=TRUE),
    sd_typed_from_hyp = sd(typed_from_hyp),
    count = n(),
    se_typed = sd_typed_from_hyp / sqrt(count)
  ) %>%
  ungroup() %>%
  filter(
    word_type == "target"
  ) %>%
  mutate(
    mean_selection_from_hyp = case_when(
      is.na(mean_selection_from_hyp) ~ 0,
      TRUE ~ mean_selection_from_hyp
    ),
    word_type_graph = case_when(
      condition == "Recall" ~ "Target: Recall",
      condition == "Confirm" ~ "Target: Confirm",
      TRUE ~ word_type
    )
  )

ggplot(data = expt1_learning_hypotheses, aes(x=exposure, y=mean_typed_from_hyp,
                                                  fill = word_type_graph)) +
  geom_col(position="dodge") +
  labs(
      x = "Exposure",
      y = "Proportion of the typed\nresponse from Exp 1",
      fill = "Word type"
    ) +
  scale_fill_manual(values=
                      # col2grey(
                        c("#5f1c99", "#b2abd2", "#e66101", "#fbd863")
                        # )
                    ) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        legend.title=element_text(size=16, face="bold"),
        legend.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        strip.text.x = element_text(size = 14)
        ) 

```

```{r expt_exp2_predict_test}
expt1_correct_exp2 <- expt1_typed_learning %>%
  filter(exposure == 2) %>%
  filter(typed_accuracy == 1) %>%
  mutate(
    index = paste(id, word)
  ) 

expt1_exp2_predict_test <- expt1_test_selections %>%
  filter(word_type == "target") %>%
  mutate(
    index = paste(id, word),
    exp2_correct = case_when(
      index %in% expt1_correct_exp2$index ~ "Exposure 2 correct",
      TRUE ~ "Exposure 2 incorrect"
    ),
    condition = factor(condition, levels = c("Recall", "Confirm")),
    noun = factor(item),
    offset = 1/9
  )

aggr_expt1_exp2_predict_test <- expt1_exp2_predict_test %>%
  group_by(condition, exp2_correct, word_type_graph) %>%
  summarize(
    count = n(),
    mean_accuracy = mean(accuracy),
    sd_accuracy = sd(accuracy),
    se_accuracy = sd_accuracy / sqrt(count)
  ) %>%
  ungroup() %>%
  mutate(
    condition = factor(
      case_when(
        condition == "Recall" ~ "Retrieval",
        TRUE ~ condition
      ), levels = c("Confirm", "Retrieval"))
  )

ggplot(aggr_expt1_exp2_predict_test, aes(x = condition, y = mean_accuracy)) +
  geom_col(aes(fill = condition)) +
  geom_label(aes(label=count, y = 0.5*mean_accuracy)) +
  geom_errorbar(aes(x=condition, ymin=mean_accuracy+se_accuracy,
                    ymax=mean_accuracy-se_accuracy),
                width=.2,
                position=position_dodge(.9)) +
  scale_fill_manual(values=
                      # col2grey(
                        c("#5f1c99", "#b2abd2")
                        # )
                    , guide = "none"
                    ) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        legend.title=element_text(size=16, face="bold"),
        legend.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        strip.text.x = element_text(size = 14)
        ) +
  facet_wrap(~exp2_correct)

contrasts(expt1_exp2_predict_test$condition) <- simple2
contrasts(expt1_exp2_predict_test$exp2_correct) <- simple2

expt1_exp2_model <- glmer(accuracy ~ exp2_correct * condition + offset(log(offset/(1 - offset))) + (1 | id),
               data=expt1_exp2_predict_test, family="binomial", control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(expt1_exp2_model)
```



## Expt 2
```{r expt2_learning}
expt2_learning_selections <- expt2_data %>%
  filter(phase == "learning") %>%
  group_by(
    condition, id, word, word_type
  ) %>%
  summarise(
    num_selections = sum(target_selected),
    item = min(item)
  )


expt2_aggr_learning_selections <-  expt2_data %>%
  filter(phase == "learning") %>%
  group_by(
    condition, word_type, exposure
  ) %>%
  summarise(
    n = n(),
    mean = mean(target_selected),
    sd = sd(target_selected),
    sem = sd / sqrt(n)
  )

ggplot(data = filter(expt2_aggr_learning_selections, word_type == "target"), aes(x = exposure, y = mean, fill = condition)) +
  geom_col(position="dodge") +
  scale_fill_manual(values=
                      # col2grey(
                        c("#5f1c99", "#b2abd2", "#e66101", "#fbd863")
                        # )
                    ) +
  facet_grid(cols = vars(condition))
```

